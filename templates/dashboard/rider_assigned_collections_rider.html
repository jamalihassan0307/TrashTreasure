{% extends 'base.html' %}
{% load static %}

{% block title %}My Assigned Collections - Rider Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/rider_dashboard.css' %}">
<style>
    .filter-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
        border: 1px solid #e9ecef;
    }
    
    .search-box {
        border-radius: 25px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    .search-box:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .status-badge {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
        font-weight: 600;
    }
    
    .collection-card {
        transition: all 0.3s ease;
        border: 1px solid #e9ecef;
        margin-bottom: 20px;
        height: 100%;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .collection-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        border-color: #667eea;
    }
    
    .collection-card.assigned {
        border: 2px solid #dc3545 !important;
        background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%);
    }
    
    .collection-card.assigned:hover {
        border-color: #dc3545 !important;
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.2);
    }
    
    .collection-card.on_the_way {
        border: 2px solid #0dcaf0 !important;
        background: linear-gradient(135deg, #f0fdff 0%, #e6f9ff 100%);
    }
    
    .collection-card.arrived {
        border: 2px solid #ffc107 !important;
        background: linear-gradient(135deg, #fffbf0 0%, #fff3e6 100%);
    }
    
    .collection-card.picked {
        border: 2px solid #fd7e14 !important;
        background: linear-gradient(135deg, #fff8f0 0%, #fff0e6 100%);
    }
    
    .collection-card.collected {
        border: 2px solid #198754 !important;
        background: linear-gradient(135deg, #f0fff4 0%, #e6ffe6 100%);
    }
    
    .collection-card.verified {
        border: 2px solid #20c997 !important;
        background: linear-gradient(135deg, #f0fffd 0%, #e6fff9 100%);
    }
    
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .filter-tag {
        background: #667eea;
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
        display: inline-block;
    }
    
    .filter-tag .remove {
        margin-left: 0.5rem;
        cursor: pointer;
        opacity: 0.8;
    }
    
    .filter-tag .remove:hover {
        opacity: 1;
    }
    
    .priority-high {
        background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        color: white;
    }
    
    .priority-medium {
        background: linear-gradient(135deg, #feca57, #ff9ff3);
        color: white;
    }
    
    .priority-low {
        background: linear-gradient(135deg, #48dbfb, #0abde3);
        color: white;
    }
    
    .collection-actions {
        margin-top: 15px;
    }
    
    .collection-actions .btn {
        margin-bottom: 5px;
        width: 100%;
    }
    
    .collection-info {
        margin-bottom: 15px;
    }
    
    .collection-info .info-item {
        margin-bottom: 8px;
    }
    
    .collection-info .info-label {
        font-weight: 600;
        color: #6c757d;
        font-size: 0.85rem;
    }
    
    .collection-info .info-value {
        color: #212529;
        font-size: 0.9rem;
    }
    
    .badge-assigned {
        background-color: #dc3545;
        color: white;
    }
    
    .badge-on_the_way {
        background-color: #0dcaf0;
        color: white;
    }
    
    .badge-arrived {
        background-color: #ffc107;
        color: black;
    }
    
    .badge-picked {
        background-color: #fd7e14;
        color: white;
    }
    
    .badge-collected {
        background-color: #198754;
        color: white;
    }
    
    .badge-verified {
        background-color: #20c997;
        color: white;
    }
    
    /* Weight Modal Styling */
    #weightModal .modal-content {
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    #weightModal .modal-header {
        border-radius: 15px 15px 0 0;
        border-bottom: 2px solid #ffc107;
    }
    
    #weightModal .form-control-lg {
        font-size: 1.1rem;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    #weightModal .form-control-lg:focus {
        border-color: #ffc107;
        box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
    }
    
    #weightModal .alert-info {
        border-radius: 10px;
        border-left: 4px solid #17a2b8;
    }
    
    #weightModal .btn-warning {
        background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);
        border: none;
        font-weight: 600;
        border-radius: 10px;
        padding: 0.75rem 1.5rem;
    }
    
    #weightModal .btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);
    }
</style>
{% endblock %}

{% block content %}
<!-- CSRF Token for API calls -->
{% csrf_token %}

<!-- Page Header -->
<div class="dashboard-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="display-5 fw-bold text-white mb-3">
                    <i class="fas fa-list me-3"></i>My Assigned Collections
                </h1>
                <p class="lead text-white-50 mb-0">
                    View and manage all your assigned trash collection requests with advanced filtering and sorting.
                </p>
            </div>
            <div class="col-lg-4 text-end">
                <a href="{% url 'dashboard:rider_dashboard' %}" class="btn btn-outline-light">
                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container py-4">
    <!-- Enhanced Filters Section -->
    <div class="filter-section">
        <div class="row g-3">
            <div class="col-lg-4">
                <label for="userSearch" class="form-label fw-bold">
                    <i class="fas fa-search me-2"></i>Search by User
                </label>
                <input type="text" class="form-control search-box" id="userSearch" 
                       placeholder="Search by username, email, or name...">
            </div>
            <div class="col-lg-3">
                <label for="statusFilter" class="form-label fw-bold">
                    <i class="fas fa-filter me-2"></i>Status Filter
                </label>
                <select class="form-select" id="statusFilter">
                    <option value="">All Statuses</option>
                    <option value="assigned">Assigned</option>
                    <option value="on_the_way">On The Way</option>
                    <option value="arrived">Arrived</option>
                    <option value="picked">Picked</option>
                    <option value="collected">Collected</option>
                    <option value="verified">Verified</option>
                </select>
            </div>
            <div class="col-lg-2">
                <label for="sortOrder" class="form-label fw-bold">
                    <i class="fas fa-sort me-2"></i>Sort By
                </label>
                <select class="form-select" id="sortOrder">
                    <option value="updated_at">Last Updated</option>
                    <option value="created_at">Created Date</option>
                    <option value="priority">Priority</option>
                    <option value="location">Location</option>
                </select>
            </div>
            <div class="col-lg-2">
                <label for="perPage" class="form-label fw-bold">
                    <i class="fas fa-list me-2"></i>Per Page
                </label>
                <select class="form-select" id="perPage">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
            </div>
            <div class="col-lg-2">
                <label class="form-label fw-bold">&nbsp;</label>
                <div class="d-grid">
                    <button class="btn btn-primary" onclick="applyFilters()">
                        <i class="fas fa-search me-2"></i>Apply
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Active Filters Display -->
        <div id="activeFilters" class="mt-3" style="display: none;">
            <h6 class="fw-bold mb-2">Active Filters:</h6>
            <div id="filterTags"></div>
            <button class="btn btn-outline-secondary btn-sm mt-2" onclick="clearAllFilters()">
                <i class="fas fa-times me-2"></i>Clear All Filters
            </button>
        </div>
    </div>

    <!-- Collections Overview -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="dashboard-card text-center">
                <div class="stats-icon mb-3">
                    <i class="fas fa-list fa-2x text-primary"></i>
                </div>
                <h4 class="fw-bold text-primary mb-2" id="totalCollections">0</h4>
                <p class="text-muted mb-0">Total Collections</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="dashboard-card text-center">
                <div class="stats-icon mb-3">
                    <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                </div>
                <h4 class="fw-bold text-danger mb-2" id="assignedCollections">0</h4>
                <p class="text-muted mb-0">Assigned (Red Border)</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="dashboard-card text-center">
                <div class="stats-icon mb-3">
                    <i class="fas fa-clock fa-2x text-warning"></i>
                </div>
                <h4 class="fw-bold text-warning mb-2" id="pendingCollections">0</h4>
                <p class="text-muted mb-0">In Progress</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="dashboard-card text-center">
                <div class="stats-icon mb-3">
                    <i class="fas fa-check-circle fa-2x text-success"></i>
                </div>
                <h4 class="fw-bold text-success mb-2" id="completedCollections">0</h4>
                <p class="text-muted mb-0">Completed</p>
            </div>
        </div>
    </div>

    <!-- Collections Display -->
    <div class="dashboard-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                <i class="fas fa-table me-2"></i>My Collections
            </h4>
            <div class="header-actions">
                <button class="btn btn-outline-primary btn-sm me-2" onclick="refreshCollections()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <span class="badge bg-primary fs-6" id="collectionsCount">0 collections</span>
            </div>
        </div>
        <div class="card-body">
            <div id="collectionsContainer">
                <!-- Collections will be populated by JavaScript -->
            </div>
            
            <!-- Empty State -->
            <div id="emptyState" class="text-center py-5" style="display: none;">
                <div class="empty-state mb-4">
                    <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">No collections found</h5>
                    <p class="text-muted">Try adjusting your filters or search criteria.</p>
                </div>
            </div>
            
            <!-- Enhanced Pagination -->
            <div id="paginationContainer" class="mt-4" style="display: none;">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <!-- Pagination Info -->
                            <div class="pagination-info mb-3 mb-md-0">
                                <span class="text-muted" id="paginationInfo">
                                    Showing 0 to 0 of 0 collections
                                </span>
                            </div>
                            
                            <!-- Pagination Controls -->
                            <nav aria-label="Collections pagination">
                                <ul class="pagination pagination-lg mb-0" id="paginationControls">
                                    <!-- Pagination will be populated by JavaScript -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Collection Detail Modal -->
<div class="modal fade" id="collectionDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>Collection Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="collectionDetailContent">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Django template data
window.collectionsData = [
    {% for submission in assigned_submissions %}
    {
        id: {{ submission.id }},
        track_id: '{{ submission.track_id|escapejs }}',
        user: { 
            username: '{{ submission.user.username|escapejs }}', 
            email: '{{ submission.user.email|escapejs }}', 
            first_name: '{{ submission.user.first_name|default:""|escapejs }}', 
            last_name: '{{ submission.user.last_name|default:""|escapejs }}' 
        },
        quantity_kg: {{ submission.quantity_kg|default:0 }},
        location: '{{ submission.location|escapejs }}',
        status: '{{ submission.status|escapejs }}',
        priority: '{{ submission.priority|default:"medium"|escapejs }}',
        created_at: '{{ submission.created_at|date:"c"|escapejs }}',
        updated_at: '{{ submission.updated_at|date:"c"|escapejs }}',
        assigned_at: '{{ submission.assigned_at|date:"c"|default:""|escapejs }}',
        rider_notes: '{{ submission.rider_notes|default:""|escapejs }}'
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

let allCollections = [];
let filteredCollections = [];
let activeFilters = {};
let currentPage = 1;
let itemsPerPage = 10;
let totalPages = 1;

document.addEventListener('DOMContentLoaded', function() {
    loadCollections();
    setupEventListeners();
});

function setupEventListeners() {
    // Search input with debouncing
    let searchTimeout;
    document.getElementById('userSearch').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            applyFilters();
        }, 300);
    });
    
    // Status and sort filter changes
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('sortOrder').addEventListener('change', applyFilters);
}

function loadCollections() {
    // Use Django template data instead of fetching
    allCollections = window.collectionsData || [];
    
    filteredCollections = [...allCollections];
    totalPages = Math.ceil(filteredCollections.length / itemsPerPage);
    updateCollectionsDisplay();
    updateStats();
    updatePagination();
}

function applyFilters() {
    const userSearch = document.getElementById('userSearch').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const sortOrder = document.getElementById('sortOrder').value;
    const perPage = document.getElementById('perPage').value;
    
    // Update items per page
    itemsPerPage = parseInt(perPage) || 10;
    currentPage = 1; // Reset to first page when filters change
    
    activeFilters = {};
    if (userSearch) activeFilters.user = userSearch;
    if (statusFilter) activeFilters.status = statusFilter;
    if (sortOrder) activeFilters.sort = sortOrder;
    if (perPage) activeFilters.perPage = perPage;
    
    filteredCollections = allCollections.filter(collection => {
        // User search filter
        if (userSearch) {
            const userMatch = collection.user.username.toLowerCase().includes(userSearch) ||
                             collection.user.email.toLowerCase().includes(userSearch) ||
                             `${collection.user.first_name} ${collection.user.last_name}`.toLowerCase().includes(userSearch);
            if (!userMatch) return false;
        }
        
        // Status filter
        if (statusFilter && collection.status !== statusFilter) {
            return false;
        }
        
        return true;
    });
    
    // Apply sorting
    applySorting(sortOrder);
    
    // Calculate total pages
    totalPages = Math.ceil(filteredCollections.length / itemsPerPage);
    
    updateCollectionsDisplay();
    updateActiveFilters();
    updatePagination();
}

function applySorting(sortOrder) {
    switch(sortOrder) {
        case 'updated_at':
            filteredCollections.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
            break;
        case 'created_at':
            filteredCollections.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            break;
        case 'priority':
            const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
            filteredCollections.sort((a, b) => priorityOrder[b.priority] - priorityOrder[a.priority]);
            break;
        case 'location':
            filteredCollections.sort((a, b) => a.location.localeCompare(b.location));
            break;
        default:
            filteredCollections.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
    }
}

function updateCollectionsDisplay() {
    const container = document.getElementById('collectionsContainer');
    const emptyState = document.getElementById('emptyState');
    const paginationContainer = document.getElementById('paginationContainer');
    
    if (filteredCollections.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        paginationContainer.style.display = 'none';
        return;
    }
    
    emptyState.style.display = 'none';
    paginationContainer.style.display = 'block';
    
    // Calculate pagination
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const paginatedCollections = filteredCollections.slice(startIndex, endIndex);
    
    // Create grid layout
    let gridHTML = '<div class="row g-4">';
    
    paginatedCollections.forEach(collection => {
        gridHTML += `
            <div class="col-lg-6 col-md-12">
                <div class="collection-card border rounded-3 p-4 h-100 ${collection.status}" data-id="${collection.id}">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h6 class="fw-bold mb-1">
                                <i class="fas fa-hashtag me-2 text-primary"></i>${collection.track_id}
                            </h6>
                            
                                <strong class="text-muted d-block">User : <small>${collection.user.username}</small></strong>
                                
                              </div>
                        <span class="badge badge-${collection.status}">${getStatusDisplay(collection.status)}</span>
                    </div>
                    
                    <div class="collection-details mb-3">
                        <div class="row g-2">
                            <div class="col-6">
                       <strong class="text-muted d-block">Location : </strong>
                                <small>${collection.location}</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">
                                    ${['picked', 'collected'].includes(collection.status) ? 'Actual Weight ✅' : 'Est. Weight'}
                                </small>
                                <strong class="${['picked', 'collected'].includes(collection.status) ? 'text-success' : ''}">
                                    ${collection.quantity_kg || 'N/A'} kg
                                </strong>
                            </div>
                        </div>
                        ${collection.rider_notes ? `
                            <div class="row g-2 mt-2">
                                <div class="col-12">
                                    <small class="text-muted d-block">Notes:</small>
                                    <small class="text-info">${collection.rider_notes}</small>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="collection-actions">
                        <div class="row g-2">
                            <div class="col-6">
                                <button class="btn btn-outline-primary btn-sm w-100" 
                                        onclick="updateStatus('${collection.id}', 'on_the_way')"
                                        ${collection.status !== 'assigned' ? 'disabled' : ''}>
                                    <i class="fas fa-motorcycle me-1"></i>On The Way
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-success btn-sm w-100" 
                                        onclick="updateStatus('${collection.id}', 'arrived')"
                                        ${!['on_the_way', 'assigned'].includes(collection.status) ? 'disabled' : ''}>
                                    <i class="fas fa-map-marker-alt me-1"></i>Arrived
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-warning btn-sm w-100" 
                                        onclick="updateStatus('${collection.id}', 'picked')"
                                        ${!['arrived', 'on_the_way'].includes(collection.status) ? 'disabled' : ''}>
                                    <i class="fas fa-hand-paper me-1"></i>Picked Up
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-success btn-sm w-100" 
                                        onclick="updateStatus('${collection.id}', 'collected')"
                                        ${collection.status !== 'picked' ? 'disabled' : ''}>
                                    <i class="fas fa-check me-1"></i>Complete
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="collection-timeline mt-3">
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>
                            Assigned: ${collection.assigned_at ? formatDate(collection.assigned_at) : 'N/A'}
                        </small>
                    </div>
                </div>
            </div>
        `;
    });
    
    gridHTML += '</div>';
    container.innerHTML = gridHTML;
    
    document.getElementById('collectionsCount').textContent = `${filteredCollections.length} collections`;
}

function updatePagination() {
    const paginationInfo = document.getElementById('paginationInfo');
    const paginationControls = document.getElementById('paginationControls');
    
    if (totalPages <= 1) {
        paginationControls.innerHTML = '';
        paginationInfo.textContent = `Showing ${filteredCollections.length} collections`;
        return;
    }
    
    // Update pagination info
    const startIndex = (currentPage - 1) * itemsPerPage + 1;
    const endIndex = Math.min(currentPage * itemsPerPage, filteredCollections.length);
    paginationInfo.textContent = `Showing ${startIndex} to ${endIndex} of ${filteredCollections.length} collections`;
    
    // Create pagination controls
    let paginationHTML = '';
    
    // First and Previous buttons
    if (currentPage > 1) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="goToPage(1)">
                    <i class="fas fa-angle-double-left"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="#" onclick="goToPage(${currentPage - 1})">
                    <i class="fas fa-angle-left"></i>
                </a>
            </li>
        `;
    } else {
        paginationHTML += `
            <li class="page-item disabled">
                <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
            </li>
            <li class="page-item disabled">
                <span class="page-link"><i class="fas fa-angle-left"></i></span>
            </li>
        `;
    }
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
            paginationHTML += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
        } else {
            paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${i})">${i}</a></li>`;
        }
    }
    
    // Next and Last buttons
    if (currentPage < totalPages) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="goToPage(${currentPage + 1})">
                    <i class="fas fa-angle-right"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="#" onclick="goToPage(${totalPages})">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            </li>
        `;
    } else {
        paginationHTML += `
            <li class="page-item disabled">
                <span class="page-link"><i class="fas fa-angle-right"></i></span>
            </li>
            <li class="page-item disabled">
                <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
            </li>
        `;
    }
    
    paginationControls.innerHTML = paginationHTML;
}

function goToPage(page) {
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        updateCollectionsDisplay();
        updatePagination();
        
        // Scroll to top of collections
        document.getElementById('collectionsContainer').scrollIntoView({ behavior: 'smooth' });
    }
}

function getStatusDisplay(status) {
    const statusConfig = {
        'assigned': 'Assigned',
        'on_the_way': 'On The Way',
        'arrived': 'Arrived',
        'picked': 'Picked',
        'collected': 'Collected',
        'verified': 'Verified'
    };
    
    return statusConfig[status] || status;
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit' 
    });
}

function updateStatus(collectionId, newStatus) {
    const collection = allCollections.find(c => c.id == collectionId);
    if (!collection) return;
    
    // Special handling for "picked" status - get actual weight
    if (newStatus === 'picked') {
        getActualWeight(collectionId, collection);
        return;
    }
    
    // For other statuses, call API to update
    updateStatusAPI(collectionId, newStatus);
}

function getActualWeight(collectionId, collection) {
    // Create a custom modal for weight input
    const modalHTML = `
        <div class="modal fade" id="weightModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title">
                            <i class="fas fa-weight me-2"></i>Record Actual Weight
                        </h5>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Collection Details:</strong><br>
                            Track ID: <code>${collection.track_id}</code><br>
                            Estimated Weight: <strong>${collection.quantity_kg || 'N/A'} kg</strong><br>
                            Location: ${collection.location}
                        </div>
                        
                        <div class="mb-3">
                            <label for="actualWeight" class="form-label fw-bold">
                                <i class="fas fa-balance-scale me-2"></i>Actual Weight (kg)
                            </label>
                            <input type="number" 
                                   class="form-control form-control-lg" 
                                   id="actualWeight" 
                                   placeholder="Enter actual weight in kg"
                                   min="0.1" 
                                   max="1000" 
                                   step="0.1"
                                   required>
                            <div class="form-text">
                                Please weigh the trash and enter the actual weight in kilograms.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="weightNotes" class="form-label">
                                <i class="fas fa-sticky-note me-2"></i>Notes (Optional)
                            </label>
                            <textarea class="form-control" 
                                      id="weightNotes" 
                                      rows="3" 
                                      placeholder="Any additional notes about the collection..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <button type="button" class="btn btn-warning" onclick="confirmWeightUpdate(${collectionId})">
                            <i class="fas fa-check me-2"></i>Update Weight & Status
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('weightModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('weightModal'));
    modal.show();
    
    // Focus on weight input
    setTimeout(() => {
        document.getElementById('actualWeight').focus();
    }, 500);
}

function confirmWeightUpdate(collectionId) {
    const actualWeight = document.getElementById('actualWeight').value;
    const weightNotes = document.getElementById('weightNotes').value;
    
    // Validate weight input
    if (!actualWeight || parseFloat(actualWeight) <= 0) {
        alert('Please enter a valid weight greater than 0 kg.');
        document.getElementById('actualWeight').focus();
        return;
    }
    
    const weight = parseFloat(actualWeight);
    if (weight > 1000) {
        alert('Weight seems too high. Please verify the weight.');
        document.getElementById('actualWeight').focus();
        return;
    }
    
    // Close modal first
    const modal = bootstrap.Modal.getInstance(document.getElementById('weightModal'));
    modal.hide();
    
    // Call API to update weight and status
    updateWeightAndStatusAPI(collectionId, weight, weightNotes);
}

// API Functions
function updateStatusAPI(collectionId, newStatus) {
    fetch(`/api/trash/update-status/${collectionId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update local data
    const collection = allCollections.find(c => c.id == collectionId);
    if (collection) {
        collection.status = newStatus;
        collection.updated_at = new Date().toISOString();
            }
        
            // Update display
        updateCollectionsDisplay();
        updateStats();
        
        // Show success message
            if (newStatus === 'collected') {
                const collection = allCollections.find(c => c.id == collectionId);
                const weight = collection ? parseFloat(collection.quantity_kg || 0) : 0;
                const pointsAwarded = Math.floor(weight * 10);
                alert(`✅ Collection completed!\nStatus: ${getStatusDisplay(newStatus)}\nPoints awarded to user: ${pointsAwarded} points (${weight}kg × 10)`);
            } else {
        alert(`Status updated to: ${getStatusDisplay(newStatus)}`);
    }
        } else {
            alert(`Error: ${data.error || 'Failed to update status'}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating status. Please try again.');
    });
}

function updateWeightAndStatusAPI(collectionId, weight, notes) {
    fetch(`/api/trash/update-weight/${collectionId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            quantity_kg: weight,
            rider_notes: notes,
            status: 'picked'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update local data
            const collection = allCollections.find(c => c.id == collectionId);
            if (collection) {
                collection.quantity_kg = weight;
                collection.status = 'picked';
                collection.rider_notes = notes;
                collection.updated_at = new Date().toISOString();
            }
            
            // Update display
            updateCollectionsDisplay();
            updateStats();
            
            // Show success message
            alert(`✅ Weight recorded: ${weight} kg\nStatus updated to: Picked`);
        } else {
            alert(`Error: ${data.error || 'Failed to update weight and status'}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating weight. Please try again.');
    });
}

function updateActiveFilters() {
    const activeFiltersDiv = document.getElementById('activeFilters');
    const filterTagsDiv = document.getElementById('filterTags');
    
    if (Object.keys(activeFilters).length === 0) {
        activeFiltersDiv.style.display = 'none';
        return;
    }
    
    activeFiltersDiv.style.display = 'block';
    filterTagsDiv.innerHTML = Object.entries(activeFilters).map(([key, value]) => `
        <span class="filter-tag">
            ${key}: ${value}
            <span class="remove" onclick="removeFilter('${key}')">&times;</span>
        </span>
    `).join('');
}

function removeFilter(key) {
    delete activeFilters[key];
    
    // Update form values
    if (key === 'user') document.getElementById('userSearch').value = '';
    if (key === 'status') document.getElementById('statusFilter').value = '';
    if (key === 'sort') document.getElementById('sortOrder').value = 'updated_at';
    
    applyFilters();
}

function clearAllFilters() {
    document.getElementById('userSearch').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('sortOrder').value = 'updated_at';
    
    activeFilters = {};
    filteredCollections = [...allCollections];
    updateCollectionsDisplay();
    updateActiveFilters();
}

function updateStats() {
    const total = allCollections.length;
    const assigned = allCollections.filter(c => c.status === 'assigned').length;
    const pending = allCollections.filter(c => ['assigned', 'on_the_way', 'arrived', 'picked'].includes(c.status)).length;
    const completed = allCollections.filter(c => ['collected', 'verified'].includes(c.status)).length;
    
    document.getElementById('totalCollections').textContent = total;
    document.getElementById('assignedCollections').textContent = assigned;
    document.getElementById('pendingCollections').textContent = pending;
    document.getElementById('completedCollections').textContent = completed;
}

function viewCollectionDetails(collectionId) {
    const collection = allCollections.find(c => c.id === collectionId);
    if (!collection) return;
    
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="fw-bold">Collection Information</h6>
                <p><strong>Track ID:</strong> ${collection.track_id}</p>
                <p><strong>Status:</strong> <span class="badge badge-${collection.status}">${getStatusDisplay(collection.status)}</span></p>
                <p><strong>Weight:</strong> 
                    <span class="${['picked', 'collected'].includes(collection.status) ? 'text-success fw-bold' : ''}">
                        ${collection.quantity_kg || 'N/A'} kg
                        ${['picked', 'collected'].includes(collection.status) ? ' ✅' : ''}
                    </span>
                </p>
                <p><strong>Address:</strong> ${collection.location}</p>
                <p><strong>Priority:</strong> <span class="badge priority-${collection.priority}">${collection.priority.toUpperCase()}</span></p>
                ${collection.rider_notes ? `<p><strong>Rider Notes:</strong> ${collection.rider_notes}</p>` : ''}
            </div>
            <div class="col-md-6">
                <h6 class="fw-bold">User Information</h6    >
                <p><strong>Username:</strong> ${collection.user.username}</p>
                <p><strong>Name:</strong> ${collection.user.first_name} ${collection.user.last_name}</p>
                <p><strong>Email:</strong> ${collection.user.email}</p>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6 class="fw-bold">Timeline</h6>
                <p><strong>Created:</strong> ${formatDate(collection.created_at)}</p>
                <p><strong>Last Updated:</strong> ${formatDate(collection.updated_at)}</p>
                ${collection.assigned_at ? `<p><strong>Assigned:</strong> ${formatDate(collection.assigned_at)}</p>` : ''}
            </div>
        </div>
    `;
    
    document.getElementById('collectionDetailContent').innerHTML = content;
    
    const modal = new bootstrap.Modal(document.getElementById('collectionDetailModal'));
    modal.show();
}

function refreshCollections() {
    const refreshBtn = document.querySelector('button[onclick="refreshCollections()"]');
    const originalContent = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
    refreshBtn.disabled = true;
    
    setTimeout(() => {
        loadCollections();
        refreshBtn.innerHTML = originalContent;
        refreshBtn.disabled = false;
    }, 500);
}
</script>
{% endblock %}
